name: CI
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
jobs:
  compose:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        # Забираем файлы репозитория на runner
        
      - name: Validate docker-compose
        run: docker compose config > /dev/null
        # Проверяем, что docker-compose.yml валиден

      - name: Up stack
        run: |
          docker volume create maildata_shared >/dev/null 2>&1 || true
          docker compose up -d
        # Создаём внешний volume и поднимаем контейнеры

      - name: Check containers are running
        run: |
          docker compose ps
          test "$(docker compose ps -q | wc -l)" -ge 1
        # Смотрим список контейнеров и проверяем, что хоть один запущен

      - name: Check Rainloop and HAProxy stats
        run: |
          curl -fsS http://localhost:8080/ > /dev/null
          curl -fsS http://localhost:8404/ > /dev/null
        # Сайт Rainloop и HAProxy отвечают по HTTP

      - name: Success output
        if: success()
        run: |
          echo "CI OK: compose валиден, контейнеры поднялись, Rainloop/HAProxy доступны."
          echo "Commit: ${{ github.sha }}"
          echo "Actor:  ${{ github.actor }}"
      - name: Down stack
        if: always()
        run: docker compose down -v
        # Всегда останавливаем и удаляем контейнеры/сеть (чистим окружение CI)
