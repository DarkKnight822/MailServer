name: Swarm CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  swarm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Init Swarm
        run: docker swarm init

      - name: Create shared volume
        run: docker volume create maildata_shared || true

      - name: Validate swarm compose
        run: docker compose -f docker-compose.swarm.yml config > /dev/null

      - name: Deploy stack
        run: docker stack deploy -c docker-compose.swarm.yml mail

      - name: Wait for services
        run: |
          sleep 5
          docker service ls

      - name: Check HTTP endpoints once
        run: |
          curl -fsS --max-time 5 http://localhost:8080/ > /dev/null
          curl -fsS --max-time 5 http://localhost:8404/ > /dev/null

      - name: Check mail service replicas
        run: |
          docker service ps mail_mailserver
          REPLICAS=$(docker service ls --format '{{.Name}} {{.Replicas}}' | awk '$1=="mail_mailserver"{print $2}')
          echo "mail_mailserver replicas: $REPLICAS"

      - name: Success output
        if: success()
        run: |
          echo "Swarm CI OK: stack deployed, endpoints available."
          echo "Commit: ${{ github.sha }}"
          echo "Actor:  ${{ github.actor }}"

      - name: Cleanup
        if: always()
        run: |
          docker stack rm mail
          docker swarm leave --force
