name: Swarm CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  swarm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Init Swarm
        run: docker swarm init

      - name: Create shared volume
        run: docker volume create maildata_shared || true

      - name: Validate swarm compose
        run: docker compose -f docker-compose.swarm.yml config > /dev/null

      - name: Deploy stack
        run: docker stack deploy -c docker-compose.swarm.yml mail

      - name: Wait for services
        run: |
          sleep 30
          docker service ls

      - name: Check HTTP endpoints
        run: |
          echo "Waiting for Rainloop on :8080..."
          for i in {1..30}; do
            if curl -fsS --max-time 5 http://localhost:8080/ > /dev/null 2>&1; then
              echo "Rainloop OK"
              break
            fi
            echo "Rainloop not ready yet ($i/30)"
            sleep 5
          done

          echo "Waiting for HAProxy stats on :8404..."
          for i in {1..30}; do
            if curl -fsS --max-time 5 http://localhost:8404/ > /dev/null 2>&1; then
              echo "HAProxy stats OK"
              break
            fi
            echo "HAProxy stats not ready yet ($i/30)"
            sleep 5
          done
          
      - name: Show haproxy logs on failure
        if: failure()
        run: |
          docker service ls
          docker service ps mail_haproxy
          docker service logs --tail 100 mail_haproxy || true

      - name: Check mail service replicas
        run: |
          docker service ps mail_mailserver
          REPLICAS=$(docker service ls --format '{{.Name}} {{.Replicas}}' | awk '$1=="mail_mailserver"{print $2}')
          echo "mail_mailserver replicas: $REPLICAS"

      - name: Success output
        if: success()
        run: |
          echo "Swarm CI OK: stack deployed, endpoints available."
          echo "Commit: ${{ github.sha }}"
          echo "Actor:  ${{ github.actor }}"

      - name: Cleanup
        if: always()
        run: |
          docker stack rm mail
          docker swarm leave --force
