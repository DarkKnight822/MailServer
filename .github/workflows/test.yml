name: Swarm CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  swarm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Init Swarm
        run: docker swarm init

      - name: Create shared volume
        run: docker volume create maildata_shared || true

      - name: Validate swarm compose
        run: docker compose -f docker-compose.swarm.yml config > /dev/null

      - name: Deploy stack
        run: docker stack deploy -c docker-compose.swarm.yml mail

      - name: Wait for services
        run: |
          sleep 20
          docker service ls

      - name: Check replicas
        run: |
          echo "Checking service replicas..."
          docker service ls

          HA=$(docker service ls --format '{{.Name}} {{.Replicas}}' | awk '$1=="mail_haproxy"{print $2}')
          MS=$(docker service ls --format '{{.Name}} {{.Replicas}}' | awk '$1=="mail_mailserver"{print $2}')
          RL=$(docker service ls --format '{{.Name}} {{.Replicas}}' | awk '$1=="mail_rainloop"{print $2}')
          DB=$(docker service ls --format '{{.Name}} {{.Replicas}}' | awk '$1=="mail_rainloop-db"{print $2}')

          echo "mail_haproxy:    $HA"
          echo "mail_mailserver: $MS"
          echo "mail_rainloop:   $RL"
          echo "mail_rainloop-db:$DB"

          [ "$HA" = "1/1" ] || { echo "haproxy replicas mismatch"; exit 1; }
          [ "$MS" = "2/2" ] || { echo "mailserver replicas mismatch"; exit 1; }
          [ "$RL" = "2/2" ] || { echo "rainloop replicas mismatch"; exit 1; }
          [ "$DB" = "1/1" ] || { echo "db replicas mismatch"; exit 1; }

      - name: Success output
        if: success()
        run: |
          echo "Swarm CI OK: stack deployed, нужное количество реплик запущено."
          echo "Commit: ${{ github.sha }}"
          echo "Actor:  ${{ github.actor }}"

      - name: Cleanup
        if: always()
        run: |
          docker stack rm mail
          docker swarm leave --force
